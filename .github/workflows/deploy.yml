name: Deploy Relay Server

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 20m
          script: |
            set -e
            
            # Install dependencies
            which git || sudo yum install -y git
            
            # Ensure Docker is running
            sudo systemctl start docker
            
            # Start Redis if not running
            docker ps | grep redis || docker run -d --name redis --restart always -p 6379:6379 redis:7-alpine redis-server --appendonly yes
            
            # Clone/update repo
            rm -rf ~/relay-server
            git clone https://github.com/${{ github.repository }}.git ~/relay-server
            cd ~/relay-server
            
            # Build with plain docker (not compose)
            sudo docker stop relay-server || true
            sudo docker rm relay-server || true
            sudo docker build -t silence-relay .
            
            # Run the server
            sudo docker run -d \
              --name relay-server \
              --restart always \
              --network host \
              -e BIND_ADDR=0.0.0.0:8080 \
              -e REDIS_URL=redis://127.0.0.1:6379 \
              -e RUST_LOG=relay_server=info \
              silence-relay
            
            # Wait and check health
            echo "Waiting for server to start..."
            sleep 30
            curl -f http://localhost:8080/health && echo "âœ… Deployment successful!"
